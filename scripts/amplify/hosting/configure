#!/usr/bin/env node

const AWS = require('aws-sdk'),
  program = require('commander'),
  promisify = require('util').promisify


  program
    .version('0.1.0')
    .description('Creates a new AWS account and adds it to the either the specified organizational unit or the root')
    .option('-n, --name <name>', 'Name of project')
    .option('-s, --stage <stage>', 'Project stage')
    .option('-c, --cloud-front-domain <cloudFrontDomain>', 'ENV - cloudFrontDomain')
    .option('-t, --sentry-url <sentryUrl>', 'ENV - sentryUrl')

  program
    .action(options => 
      Promise.resolve(
        client = new AWS.Amplify({
          apiVersion: '2017-07-25',
          region: 'us-east-1',
          credentials: new AWS.SharedIniFileCredentials({
            profile: `${options.name}-${options.stage}developer`,
            filename: `${process.env['HOME']}/.aws/credentials`
          }),
        })
      )
      .then(client =>
        promisify(client.createApp.bind(client))({
          name: `${options.name}-${options.stage}`, /* required */
          oauthToken: 'STRING_VALUE', /* required */
          platform: 'WEB',
          repository: `https://git-codecommit.us-east-1.amazonaws.com/v1/repos/${options.name}-${options.stage}/`, /* required */
          customRules: [
            {
              "source":"</^[^.]+$|\.(?!(css|json|gif|ico|jpg|js|png|txt|svg|woff|ttf)$)([^.]+$)/>",
              "target":"/index.html",
              "status":"200"
            },
            {
              "source":"/<*>",
              "target":"/index.html",
              "status":"404"
            }
          ],
          enableBasicAuth: false,
          enableBranchAutoBuild: true,
          environmentVariables: {
            'REACT_APP_cdn': options.cloudFrontDomain,
            'REACT_APP_sentry_url': options.sentryUrl,
          },
        })
        .then(console.log)
        .catch(console.log)
      )
    )

  program.parse(process.argv);
